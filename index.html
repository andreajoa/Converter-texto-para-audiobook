<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß Conversor de Texto para Audiobook</title>
    <!-- O MESMO CSS, pode colar do seu original acima -->
    <style>
        /* [TODO]: COLE O SEU CSS ORIGINAL AQUI, POIS J√Å √â BOM */
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>üéß Gerando Audiobook...</h3>
            <p>Por favor, aguarde enquanto processamos seu conte√∫do</p>
        </div>
    </div>

    <div class="container">
        <div class="status-indicator" id="statusIndicator">üîÑ Verificando...</div>
        
        <div class="header">
            <h1>üéß Conversor para Audiobook</h1>
            <p>Transforme seus textos e documentos em audiobooks profissionais</p>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('text', event)">üìù Texto</button>
                <button class="tab" onclick="switchTab('file', event)">üìÑ Arquivo</button>
            </div>

            <!-- Aba de Texto -->
            <div class="tab-content active" id="textTab">
                <form id="textForm" autocomplete="off">
                    <div class="form-group">
                        <label class="form-label" for="textInput">Cole seu texto aqui:</label>
                        <textarea class="form-textarea" id="textInput" required minlength="10"
                        placeholder="Digite ou cole o texto que deseja converter em audiobook...

Exemplo:
Era uma vez, em um reino muito distante..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="voiceSelect">Selecione a voz:</label>
                        <select class="form-select" id="voiceSelect" required>
                            <option value="">Carregando vozes...</option>
                        </select>
                        <div class="voice-info" id="voiceInfo"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="speedRange">Velocidade da fala:</label>
                        <div class="range-container">
                            <input type="range" class="range-input" id="speedRange" min="0.5" max="2.0" step="0.1" value="1.0">
                            <div class="range-value" id="speedValue">1.0x</div>
                        </div>
                    </div>
                    <button type="submit" class="btn" id="convertTextBtn">
                        üé§ Converter Texto para Audiobook
                    </button>
                </form>
            </div>

            <!-- Aba de Arquivo -->
            <div class="tab-content" id="fileTab">
                <form id="fileForm" autocomplete="off">
                    <div class="form-group">
                        <label class="form-label">Envie seu arquivo:</label>
                        <div class="file-upload">
                            <input type="file" class="file-input" id="fileInput" accept=".txt" required>
                            <label class="file-label" for="fileInput" id="fileLabel">
                                <div>
                                    <div style="font-size: 3rem; margin-bottom: 15px;">üìÅ</div>
                                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                                        Clique para selecionar ou arraste um arquivo
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 15px;">
                                        Formato suportado: <span class="format-tag">TXT</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 10px;">
                                        M√°ximo: 50MB
                                    </div>
                                </div>
                            </label>
                        </div>
                        <div class="file-info" id="fileInfo">
                            <div class="file-info-content" id="fileInfoContent"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="fileVoiceSelect">Selecione a voz:</label>
                        <select class="form-select" id="fileVoiceSelect" required>
                            <option value="">Carregando vozes...</option>
                        </select>
                        <div class="voice-info" id="fileVoiceInfo"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="fileSpeedRange">Velocidade da fala:</label>
                        <div class="range-container">
                            <input type="range" class="range-input" id="fileSpeedRange" min="0.5" max="2.0" step="0.1" value="1.0">
                            <div class="range-value" id="fileSpeedValue">1.0x</div>
                        </div>
                    </div>
                    <button type="submit" class="btn" id="convertFileBtn">
                        üé§ Converter Arquivo para Audiobook
                    </button>
                </form>
            </div>

            <!-- Resultado -->
            <div class="result" id="result">
                <h3 id="resultTitle"></h3>
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let voices = {};
        let apiStatus = false;

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            checkApiStatus();
            loadVoices();
            setupEventListeners();
        });

        // ========== STATUS DA API ==========
        async function checkApiStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                if (data.status === 'online') {
                    updateStatusIndicator('online', 'Online - ' + (data.tts_engine ? data.tts_engine.toUpperCase() : 'GTTS'));
                    apiStatus = true;
                } else {
                    updateStatusIndicator('offline', 'Offline');
                }
            } catch (error) {
                updateStatusIndicator('offline', 'Erro de conex√£o');
            }
        }

        function updateStatusIndicator(status, text) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = (status === "online" ? '‚úÖ ' : '‚ùå ') + text;
            indicator.className = 'status-indicator status-' + status;
        }

        // ========== CARREGAR VOZES ==========
        async function loadVoices() {
            try {
                const response = await fetch('/voices');
                const data = await response.json();
                if (data.success && data.voices) {
                    voices = data.voices;
                    populateVoiceSelects();
                }
            } catch (error) {
                voices = {
                    'pt-BR': { name: 'Portugu√™s Brasil', gender: 'Feminina', country: 'Brasil' },
                    'pt': { name: 'Portugu√™s Portugal', gender: 'Feminina', country: 'Portugal' },
                    'en': { name: 'English', gender: 'Female', country: 'United States' }
                };
                populateVoiceSelects();
            }
        }

        function populateVoiceSelects() {
            ['voiceSelect', 'fileVoiceSelect'].forEach(function(selectId) {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                if (!voices || Object.keys(voices).length === 0) {
                    select.innerHTML = '<option value="">Nenhuma voz dispon√≠vel</option>';
                    return;
                }
                Object.entries(voices).forEach(([voiceId, voiceData]) => {
                    const option = document.createElement('option');
                    option.value = voiceId;
                    option.textContent = voiceData.name;
                    select.appendChild(option);
                });
                select.selectedIndex = 0;
                updateVoiceInfo(selectId);
            });
        }

        function updateVoiceInfo(selectId) {
            const select = document.getElementById(selectId);
            const infoId = selectId.replace('Select', 'Info');
            const info = document.getElementById(infoId);
            const selectedVoice = voices[select.value];
            info.textContent = selectedVoice ? (selectedVoice.gender + ' ‚Ä¢ ' + selectedVoice.country) : '';
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            document.getElementById('speedRange').addEventListener('input', function() {
                document.getElementById('speedValue').textContent = this.value + 'x';
            });
            document.getElementById('fileSpeedRange').addEventListener('input', function() {
                document.getElementById('fileSpeedValue').textContent = this.value + 'x';
            });
            document.getElementById('voiceSelect').addEventListener('change', () => updateVoiceInfo('voiceSelect'));
            document.getElementById('fileVoiceSelect').addEventListener('change', () => updateVoiceInfo('fileVoiceSelect'));
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            document.getElementById('fileLabel').addEventListener('dragover', function(e) {
                e.preventDefault(); this.classList.add('dragover');
            });
            document.getElementById('fileLabel').addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            document.getElementById('fileLabel').addEventListener('drop', function(e) {
                e.preventDefault(); this.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    document.getElementById('fileInput').files = e.dataTransfer.files;
                    handleFileSelect();
                }
            });
            document.getElementById('textForm').addEventListener('submit', handleTextSubmit);
            document.getElementById('fileForm').addEventListener('submit', handleFileSubmit);
        }

        // ========== TROCAR ABA ==========
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            hideResult();
        }

        // ========== FILE SELECTION ==========
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const fileInfoContent = document.getElementById('fileInfoContent');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const maxSize = 50 * 1024 * 1024; // 50MB
                let statusColor = '#10b981';
                let statusText = 'Arquivo v√°lido';
                if (file.size > maxSize) {
                    statusColor = '#ef4444';
                    statusText = 'Arquivo muito grande (m√°x. 50MB)';
                }
                fileInfoContent.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center;"><div><strong>üìÑ ${file.name}</strong><br><span style="color: #6b7280;">Tamanho: ${formatFileSize(file.size)} ‚Ä¢ Tipo: ${file.type || 'Texto'}</span></div><div style="color: ${statusColor}; font-weight: 600;">${statusText}</div></div>`;
                fileInfo.style.display = 'block';
            } else {
                fileInfo.style.display = 'none';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ========== LOADING ==========
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ========== FORM SUBMIT TEXT ==========
        async function handleTextSubmit(e) {
            e.preventDefault();
            const text = document.getElementById('textInput').value.trim();
            const voice = document.getElementById('voiceSelect').value;
            const speed = document.getElementById('speedRange').value;

            if (!text || text.length < 10) {
                showResult('error', 'Erro', 'Por favor, digite um texto de pelo menos 10 caracteres.');
                return;
            }
            await convertToAudio({ text, voice, speed }, 'convertTextBtn');
        }

        // ========== FORM SUBMIT FILE ==========
        async function handleFileSubmit(e) {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const voice = document.getElementById('fileVoiceSelect').value;
            const speed = document.getElementById('fileSpeedRange').value;
            if (!fileInput.files.length) {
                showResult('error', 'Erro', 'Por favor, selecione um arquivo para converter.');
                return;
            }
            const file = fileInput.files[0];
            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                showResult('error', 'Erro', 'Arquivo muito grande. O tamanho m√°ximo √© 50MB.');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('voice', voice);
            formData.append('speed', speed);
            await convertToAudio(formData, 'convertFileBtn', true);
        }

        // ========== CHAMADA PARA BACKEND ==========
        async function convertToAudio(data, buttonId, isFile = false) {
            const button = document.getElementById(buttonId);
            button.disabled = true;
            button.classList.add('btn-loading');
            showLoading();
            hideResult();
            try {
                const options = { method: 'POST' };
                if (isFile) {
                    options.body = data;
                } else {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(data);
                }
                const response = await fetch('/convert', options);
                const result = await response.json();
                if (result.success) {
                    showSuccessResult(result);
                } else {
                    showResult('error', 'Erro na Convers√£o', result.error || 'Erro desconhecido');
                }
            } catch (error) {
                showResult('error', 'Erro de Conex√£o', 'N√£o foi poss√≠vel conectar com o servidor.');
            } finally {
                button.disabled = false;
                button.classList.remove('btn-loading');
                hideLoading();
            }
        }

        // ========== RESULTADO ==========
        function showSuccessResult(data) {
            const resultContent = `
                <div class="result-info">
                    <div class="result-item"><strong>Tamanho do Arquivo:</strong> ${data.file_size_mb} MB (${data.file_size} bytes)</div>
                    <div class="result-item"><strong>Texto Processado:</strong> ${data.text_length} caracteres</div>
                    <div class="result-item"><strong>Chunks Processados:</strong> ${data.chunks_processed}</div>
                    <div class="result-item"><strong>Voz Utilizada:</strong> ${(voices[data.voice] ? voices[data.voice].name : data.voice)}</div>
                    <div class="result-item"><strong>Velocidade:</strong> ${data.speed}x</div>
                    <div class="result-item"><strong>Dura√ß√£o Estimada:</strong> ~${data.estimated_duration_minutes} minutos</div>
                </div>
                <a href="${data.download_url}" class="download-btn" download="${data.filename}">
                    üì• Baixar Audiobook (${data.filename})
                </a>
            `;
            showResult('success', '‚úÖ Audiobook Gerado com Sucesso!', resultContent);
        }

        function showResult(type, title, content) {
            const result = document.getElementById('result');
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultContent').innerHTML = content;
            result.className = 'result ' + type;
            result.style.display = 'block';
            setTimeout(() => result.scrollIntoView({ behavior: 'smooth' }), 100);
        }

        function hideResult() {
            document.getElementById('result').style.display = 'none';
        }
    </script>
</body>
</html>
